<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Polo Stats Tracker</title>
    <style>
        #form {
            display: flex;
            align-items: center; /* Align items vertically */
            gap: 10px; /* Add spacing between elements */
        }

        /* Style for the text area */
        #inputText {
            width: 300px; /* Fixed width for the text area */
            height: 80px; /* Fixed height for the text area */
        }

        /* Style for the microphone button */
        #microphoneButton {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        #microphoneButton img {
            width: 40px; /* Adjust width for a clean appearance */
            height: 40px; /* Adjust height for a square button */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid black;
            text-align: center;
            padding: 8px;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Water Polo Statistics Tracker</h1>

    <!-- Form for inputting text or speech -->
    <form id="form" data-game-id="{{ game_index }}">
        <input type="hidden" name="home_team" value="{{ home_team }}">
        <input type="hidden" name="away_team" value="{{ away_team }}">
        <input type="hidden" name="game_id" value="{{ game_index }}">
        <textarea id="inputText" rows="4" cols="50" placeholder="Enter or speak your stats..."></textarea><br>
        <!-- Microphone button placed between the text area and submit button -->
        <button type="button" id="microphoneButton" style="background: none; border: none; padding: 0; cursor: pointer;">
            <img src="{{ url_for('static', filename='images/microphone.png') }}" alt="Microphone" style="width: 50px; height: 50px;">
        </button>
        <button type="submit">Submit</button>
    </form>

    <p><strong>Result:</strong> <span id="result"></span></p>

    <!-- Button to show or hide the box score -->
    <button id="showBoxScoreButton">Show Box Score</button>

    <!-- Container for tables (Initially hidden) -->
    <div id="tablesContainer" style="display: none;">
        <h2>Away Team ({{ away_team }})</h2>
        <table border="1" id="awayTeamTable">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Goals</th>
                    <th>Shot Attempts</th>
                    <th>Assists</th>
                    <th>Blocks</th>
                    <th>Steals</th>
                    <th>Exclusions</th>
                    <th>Exclusions Drawn</th>
                    <th>Penalties</th>
                    <th>Turnovers</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>Home Team ({{ home_team }})</h2>
        <table border="1" id="homeTeamTable">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Goals</th>
                    <th>Shot Attempts</th>
                    <th>Assists</th>
                    <th>Blocks</th>
                    <th>Steals</th>
                    <th>Exclusions</th>
                    <th>Exclusions Drawn</th>
                    <th>Penalties</th>
                    <th>Turnovers</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Form to end the game -->
    <form id="endGameForm" action="/end_game" method="post">
        <input type="hidden" name="white_team_name" value="{{ home_team }}">
        <input type="hidden" name="black_team_name" value="{{ away_team }}">
        <input type="hidden" name="game_index" value="{{ game_index }}">
        <input type="hidden" name="school_slug" value="{{ school_slug }}">
        <button type="submit">Finish Game</button>
    </form>

    <script>
        // Reset stats when page loads
        window.onload = async function() {
            try {
                await fetch('/reset_stats', {
                    method: 'POST'
                });
                updateTables();  // Refresh the display
            } catch (error) {
                console.error("Error resetting stats:", error);
            }
        }

        // Process form submission for text input
        document.getElementById('form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const inputText = document.getElementById('inputText').value;
            const homeTeam = document.querySelector('input[name="home_team"]').value;
            const awayTeam = document.querySelector('input[name="away_team"]').value;
            const gameId = document.querySelector('input[name="game_id"]').value; //Added gameId
            console.log("Submitting text:", inputText);
            console.log("Home team:", homeTeam);
            console.log("Away team:", awayTeam);
            console.log("Game ID:", gameId); //Added gameId


            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `text=${encodeURIComponent(inputText)}&home_team=${encodeURIComponent(homeTeam)}&away_team=${encodeURIComponent(awayTeam)}&game_id=${encodeURIComponent(gameId)}` //Added gameId
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('result').innerText = data.response || 'Success';
                } else {
                    console.error("Error in response:", response.status);
                    document.getElementById('result').innerText = 'Error processing text.';
                }
                document.getElementById('inputText').value = '';
            } catch (error) {
                console.error("Error processing text:", error);
                document.getElementById('result').innerText = 'Error processing text.';
            }
        });

        // Start and stop speech recognition based on button press
        const microphoneButton = document.getElementById('microphoneButton');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = true;

        let isRecording = false;

        microphoneButton.addEventListener('mousedown', () => {
            if (!isRecording) {
                recognition.start();
                isRecording = true;
                console.log("Recording started...");
            }
        });

        microphoneButton.addEventListener('mouseup', () => {
            if (isRecording) {
                recognition.stop();
                isRecording = false;
                console.log("Recording stopped.");
            }
        });

        recognition.onresult = async function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('inputText').value = transcript;

            // Immediately process the recognized text
            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `text=${encodeURIComponent(transcript)}&home_team=${encodeURIComponent(homeTeam)}&away_team=${encodeURIComponent(awayTeam)}&game_id=${encodeURIComponent(gameId)}` //Added gameId
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('result').innerText = data.response || 'Success';
                } else {
                    console.error("Error in response:", response.status);
                    document.getElementById('result').innerText = 'Error processing text.';
                }
            } catch (error) {
                console.error("Error processing text:", error);
                document.getElementById('result').innerText = 'Error processing text.';
            }
        };

        // Show or hide the box score when the button is clicked
        const showBoxScoreButton = document.getElementById('showBoxScoreButton');
        const tablesContainer = document.getElementById('tablesContainer');

        showBoxScoreButton.addEventListener('click', () => {
            // Toggle visibility of the tables container
            const isVisible = tablesContainer.style.display !== 'none';
            tablesContainer.style.display = isVisible ? 'none' : 'block';

            // Change button text based on the visibility of the tables container
            showBoxScoreButton.innerText = isVisible ? 'Show Box Score' : 'Hide Box Score';
        });

        // Update tables with data from rosters
        // Update tables with data from rosters
        // Update tables with live data
        async function updateTables() {
            try {
                const gameId = document.getElementById('form').getAttribute('data-game-id');
                // Fetch updated data from the server with game ID
                const response = await fetch(`/get_data?home_team={{ home_team }}&away_team={{ away_team }}&game_id=${gameId}`);

                if (!response.ok) {
                    console.error(`Error fetching data: ${response.status}`);
                    return;
                }

                const data = await response.json();

                // Update the Away Team Table
                const awayTableBody = document.querySelector('#awayTeamTable tbody');
                awayTableBody.innerHTML = ''; // Clear the current rows

                (data.away_box?.Player || []).forEach((player, index) => {
                    const row = `
                        <tr>
                            <td>${player || ''}</td>
                            <td>${data.away_box?.Shot?.[index] || 0}</td>
                            <td>${data.away_box?.['Shot Attempt']?.[index] || 0}</td>
                            <td>${data.away_box?.Assists?.[index] || 0}</td>
                            <td>${data.away_box?.Blocks?.[index] || 0}</td>
                            <td>${data.away_box?.Steals?.[index] || 0}</td>
                            <td>${data.away_box?.Exclusions?.[index] || 0}</td>
                            <td>${data.away_box?.['Exclusions Drawn']?.[index] || 0}</td>
                            <td>${data.away_box?.Penalties?.[index] || 0}</td>
                            <td>${data.away_box?.Turnovers?.[index] || 0}</td>
                        </tr>`;
                    awayTableBody.innerHTML += row;
                });

                // Update the Home Team Table
                const homeTableBody = document.querySelector('#homeTeamTable tbody');
                homeTableBody.innerHTML = ''; // Clear the current rows

                (data.home_box?.Player || []).forEach((player, index) => {
                    const row = `
                        <tr>
                            <td>${player || ''}</td>
                            <td>${data.home_box?.Shot?.[index] || 0}</td>
                            <td>${data.home_box?.['Shot Attempt']?.[index] || 0}</td>
                            <td>${data.home_box?.Assists?.[index] || 0}</td>
                            <td>${data.home_box?.Blocks?.[index] || 0}</td>
                            <td>${data.home_box?.Steals?.[index] || 0}</td>
                            <td>${data.home_box?.Exclusions?.[index] || 0}</td>
                            <td>${data.home_box?.['Exclusions Drawn']?.[index] || 0}</td>
                            <td>${data.home_box?.Penalties?.[index] || 0}</td>
                            <td>${data.home_box?.Turnovers?.[index] || 0}</td>
                        </tr>`;
                    homeTableBody.innerHTML += row;
                });

                console.log("Tables updated successfully.");

            } catch (error) {
                console.error("Error updating tables:", error);
            }
        }

        // Update tables after form submission and initially
        document.getElementById('form').addEventListener('submit', function() {
            setTimeout(updateTables, 500); // Update shortly after submission
        });
        updateTables(); // Initial update


    </script>
</body>
</html>